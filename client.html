<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Um jogo qualquer</title>

    <style>
        #screen {
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
            border: 10px solid #CCC;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering:-moz-crisp-edges ;
            width: 400px;
            height: 400px;
        }
    </style>

</head>


<body>
    <canvas id="screen" width="10" height="10"></canvas>
    <audio id="audio">
        <source src="SomFruta.mp3" type="audio/mpeg">
    </audio>
    

    <script>
        const screen = document.getElementById('screen');
        const audio = document.getElementById('audio');
        const context = screen.getContext('2d');
        
        
        
        
        
        
        function createGame(){
            const state = {
                players: {},
                fruits: {}
            }


            function addPlayer(command) {
                const playerID = command.playerID
                const playerX = command.playerX
                const playerY = command.playerY

                state.players[playerID] = {
                    x: playerX,
                    y: playerY
                }
            }

            function removePlayer(command) {
                const playerID = command.playerID

                delete state.players[playerID]
            }

            function addFruit(command) {
                const fruitID = command.fruitID
                const fruitX = command.fruitX
                const fruitY = command.fruitY

                state.fruits[fruitID] = {
                    x: fruitX,
                    y: fruitY
                }
            }

            function removeFruit(command) {
                const fruitID = command.fruitID
                delete state.fruits[fruitID]
            }

            function checkForFruitCollision(playerID) {
                player = state.players[playerID]
                for (const fruitID in state.fruits) {
                    const fruit = state.fruits[fruitID]
                    if (player.x === fruit.x && player.y === fruit.y) {
                        audio.play()
                        removeFruit({ fruitID: fruitID })
                    }
                }
            }





            function movePlayer(command){
                const aceptedMoves = {
                    ArrowUp(player) {
                        if(player.y > 0) {
                            player.y -= 1
                        }
                        else {
                            player.y = screen.height-1
                        }
                    },
                    ArrowDown(player) {
                        if(player.y < screen.height-1) {
                            player.y += 1
                        }
                        else {
                            player.y = 0
                        }
                    },
                    ArrowLeft(player) {
                        if(player.x > 0) {
                            player.x -= 1
                        }
                        else {
                            player.x = screen.width-1
                        }
                    },
                    ArrowRight(player) {
                        if(player.x < screen.width-1) {
                            player.x += 1
                        }
                        else {
                            player.x = 0
                        }
                    }
                }    
                                       
                const keyPressed = command.keyPressed
                const playerID = command.playerID
                const player = state.players[playerID]
                
                const moveFunction = aceptedMoves[keyPressed]
                if (player && moveFunction) {
                    moveFunction(player)
                    checkForFruitCollision(playerID)
                }
 
                return 
                
            }
            
            return{
                    movePlayer,
                    state,
                    addPlayer,
                    removePlayer,
                    addFruit,
                    removeFruit
            }
            

        }

        const game = createGame()
 
        game.addPlayer({playerID: "player1", playerX: 1, playerY:1})
        game.addPlayer({playerID: "player2", playerX: 2, playerY:2})
        game.addFruit({fruitID: "fruit1", fruitX: 3, fruitY:5})
        game.addFruit({fruitID: "fruit2", fruitX: 5, fruitY:7})

        const keyboardListener = createKeyboardListener()
        keyboardListener.subscribe(game.movePlayer)
        




        function createKeyboardListener() {

            const state = {
                observers: []
            }

            function subscribe(observerFunction) {
                state.observers.push(observerFunction)
            }

            function notifyAll(command){
                for (const observerfunction of state.observers){
                    observerfunction(command);
                }
            }

            document.addEventListener('keydown', handleKeyDown);

            function handleKeyDown(event){
            const keyPressed = event.key

            const command = {   
                playerID: 'player1', 
                keyPressed
            }

            notifyAll(command);
            }

            return {
                subscribe
            }

        }

 



        renderScreen();


        function renderScreen(){
            context.clearRect (0,0, screen.width, screen.height);
            
            for (const playerID in game.state.players){
                const player = game.state.players[playerID];
                context.fillStyle = 'black';
                context.fillRect(player.x , player.y , 1 , 1);
            }

            for(const fruitID in game.state.fruits){
                const fruit = game.state.fruits[fruitID];
                context.fillStyle='green';
                context.fillRect(fruit.x , fruit.y , 1 , 1);
            }

            requestAnimationFrame(renderScreen);
        }



    </script>

</body>
</html>